#!/bin/sh
#
# Docker SSH shell forwarder
#
# Makes all 'vagrant ssh' invocations seamslessly run inside the Docker container
# and not on the host Vagrant box, making it a fully transparent boot2Docker host.
#
# To escape this dockershell and get to the host Vagrant box, run
#  vagrant ssh -c 'touch /home/vagrant/.nodocker'
#  vagrant ssh
#

set -e

SSH_FLAGS="-A -i "/home/vagrant/.ssh/id_rsa_vagrant" -p 2222 -o StrictHostKeyChecking=no"
DOCKER_CONTAINER="seravo_wordpress"

# After boot, once wait for the Docker to start
if [ ! -e /tmp/.dockerwait ]
then
    sleep 15
    touch /tmp/.dockerwait
fi

# Wait for SSH port to become active
while ! nc -z localhost 2222
do
    echo "Waiting for container SSH..."
    sleep 10
done

echo "entering site container... $@"

if [ -n "${DOCKERSHELL_WRAPPER}" ]
then
    # When running via the wp-wrapper, keep SSH silent with -q to
    # avoid displaying too many SSH banners.
    ssh ${SSH_FLAGS} -q root@localhost "$@"
else
    ssh ${SSH_FLAGS} vagrant@localhost "$@"
fi
